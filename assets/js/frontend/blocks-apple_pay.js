(()=>{"use strict";const e=window.React,t=window.wp.i18n,a=window.wc.wcBlocksRegistry,s=window.wp.htmlEntities,n=window.wc.wcSettings,o=window.wp.element,c="apple_pay",r=(0,n.getSetting)("apple_pay_data",{}),i=(0,n.getSetting)("google_pay_data",{});let l=!1;r.is_apple_pay_express_enabled&&r.is_google_pay_express_enabled&&(l=!0);const d=function(e,t){!0===r.log_errors&&r.log_error_endpoint&&fetch(r.log_error_endpoint,{method:"POST",credentials:"same-origin",headers:new Headers({"Content-Type":"application/json"}),body:JSON.stringify({message:e,context:t})}).catch((e=>{}))},p="paysafe_js"===r.integration_type,u=(0,s.decodeEntities)(r.title)||"Paysafe Checkout",m=()=>(0,e.createElement)("div",{className:"paysafe-gateway-title"},(0,e.createElement)("span",null,u),(0,e.createElement)("img",{className:"paysafe-gateway-image",src:r.icon,alt:u}));let y=0,h={},g=null,_=null,f=!1;const E=function(e,a,s){if(!jQuery("#paysafe-hosted-apple-pay-payment-form").length)return;if(f)return;if("undefined"==typeof paysafe||void 0===paysafe.fields)return void setTimeout((function(){E(e,a,s)}),1e3);f=!0;const n={currencyCode:r.currency_code,environment:r.test_mode?"TEST":"LIVE",transactionSource:"WooCommerceJs",accounts:{default:r.account_id,applePay:r.account_id},fields:{applePay:{selector:"#paysafe-apple-pay",type:"buy",label:(0,t.__)("Pay with Apple Pay","paysafe-checkout"),color:"black",buttonWidth:"240px",buttonHeight:"55px"}}};l&&(n.accounts.googlePay=i.account_id,n.fields.googlePay={selector:"#paysafe-google-pay",type:"buy",color:"black",label:(0,t.__)("Google Pay","paysafe-checkout"),merchantId:i.express_merchant_ref_num,country:i.google_pay_issuer_country,buttonWidth:"240px",buttonHeight:"55px"}),y=parseInt(h.cartTotals.total_price);let o=h.billingAddress.address_1,p=(h.billingAddress.address_2,h.billingAddress.city),u=h.billingAddress.postcode,m=h.billingAddress.state,g=h.billingAddress.country,R=!1;paysafe.fields.setup(r.authorization,n).then((e=>(_=e,e.show()))).then((a=>{a.applePay&&!a.applePay.error&&document.getElementById("paysafe-apple-pay").addEventListener("click",(function(a){if(a.preventDefault(),a.stopPropagation(),e(),y=parseInt(h.cartTotals.total_price),!y)return d("ERROR: Express checkout order amount is not set",[]),void s((0,t.__)("ERROR: Express checkout order amount is not set","paysafe-checkout"));R=!0;const n=h.cartTotals.currency_code,i=r.express_merchant_ref_num||"apple_pay_"+Date.now(),l={transactionSource:"WooCommerceJs",amount:y,transactionType:"PAYMENT",currency:n,merchantRefNum:i,environment:r.test_mode?"TEST":"LIVE",paymentType:"APPLEPAY",applePay:{country:g},accountId:r.account_id,customerDetails:{billingDetails:{country:g,zip:u,street:o,city:p,state:m}}};_.tokenize(l).then((e=>{const a=e.token||null;if(!a){const e=(0,t.__)("ERROR: Express checkout couldn't tokenize the payment information","paysafe-checkout");return d(e,[]),void s(e)}fetch(r.express_checkout_endpoint,{method:"POST",credentials:"same-origin",headers:new Headers({"Content-Type":"application/json"}),body:JSON.stringify({gateway_id:c,nonce:r.nonce})}).then((e=>e.json())).then((e=>{if("success"===e.status){const n=e.order_id||null;if(!n)return d("ERROR: Express checkout couldn't create Order",[]),void s((0,t.__)("ERROR: Express checkout couldn't create the order","paysafe-checkout"));const o={orderId:n,paymentMethod:"APPLEPAY",transactionType:"PAYMENT",paymentHandleToken:a,amount:y,customerOperation:"",merchantRefNum:i,nonce:r.nonce};fetch(r.register_url,{method:"POST",credentials:"same-origin",headers:new Headers({"Content-Type":"application/json"}),body:JSON.stringify(o)}).then((e=>e.json())).then((e=>{"success"===e.status?_.complete("success"):(s("ERROR: Express checkout payment failed"+(e.message?" ("+e.message+")":"")),_.complete("fail")),window.location=e.redirect_url})).catch((e=>{const t="ERROR "+e.code+": "+e.detailedMessage;d(t,[]),s(t),_.complete("fail")}))}else s((0,t.__)("ERROR: Express checkout couldn't create the order","paysafe-checkout"))})).catch((e=>{const t="ERROR "+e.code+": "+e.detailedMessage;d(t,[]),s(t),_.complete("fail")}))})).catch((e=>{let t="ERROR "+e.code+(e.detailedMessage?": "+e.detailedMessage:"");e.displayMessage&&(t=e.displayMessage+(e.detailedMessage?": "+e.detailedMessage:"")),d(t,[]),e.detailedMessage&&e.detailedMessage.includes("User aborted payment")?s(e.detailedMessage):s(t)}))}),!1),l&&a.googlePay&&!a.googlePay.error&&document.getElementById("paysafe-google-pay").addEventListener("click",(function(a){a.preventDefault(),a.stopPropagation(),e(),R=!0,fetch(i.express_checkout_endpoint,{method:"POST",credentials:"same-origin",headers:new Headers({"Content-Type":"application/json"}),body:JSON.stringify({gateway_id:"google_pay",nonce:i.nonce})}).then((e=>e.json())).then((e=>{if("success"===e.status){if(y=parseInt(h.cartTotals.total_price),!y)return d("ERROR: Express checkout order amount is not set",[]),void s((0,t.__)("ERROR: Express checkout order amount is not set","paysafe-checkout"));const a=e.order_id||null;if(!a)return d("ERROR: Express checkout couldn't create Order",[]),void s((0,t.__)("ERROR: Express checkout couldn't create the order","paysafe-checkout"));const n=h.cartTotals.currency_code,c=e.merchant_ref_num||"google_pay_"+Date.now(),r={transactionSource:"WooCommerceJs",amount:y,transactionType:"PAYMENT",currency:n,merchantRefNum:c,environment:i.test_mode?"TEST":"LIVE",paymentType:"GOOGLEPAY",googlePay:{country:i.google_pay_issuer_country,requiredBillingContactFields:["email"],requiredShippingContactFields:["name"]},accountId:i.account_id,customerDetails:{billingDetails:{country:g,zip:u,street:o,city:p,state:m}},threeDs:{merchantUrl:i.checkout_url,deviceChannel:"BROWSER",messageCategory:"PAYMENT",authenticationPurpose:"PAYMENT_TRANSACTION",transactionIntent:"GOODS_OR_SERVICE_PURCHASE"}};_.tokenize(r).then((e=>{const t={orderId:a,paymentMethod:"GOOGLEPAY",transactionType:"PAYMENT",paymentHandleToken:e.token,amount:y,customerOperation:"",merchantRefNum:c,nonce:i.nonce};fetch(i.register_url,{method:"POST",credentials:"same-origin",headers:new Headers({"Content-Type":"application/json"}),body:JSON.stringify(t)}).then((e=>e.json())).then((e=>{"success"===e.status?_.complete("success"):(s("ERROR: Express checkout payment failed"+(e.message?" ("+e.message+")":"")),_.complete("fail")),window.location=e.redirect_url})).catch((e=>{const t="ERROR "+e.code+": "+e.detailedMessage;d(t,[]),s(t),_.complete("fail")}))})).catch((e=>{let t="ERROR "+e.code+(e.detailedMessage?": "+e.detailedMessage:"");e.displayMessage&&(t=e.displayMessage+(e.detailedMessage?": "+e.detailedMessage:"")),d(t,[]),e.detailedMessage&&e.detailedMessage.includes("User aborted payment")?s(e.detailedMessage):s(t)}))}else s((0,t.__)("ERROR: Express checkout couldn't create the order","paysafe-checkout"))}))}),!1)})).catch((e=>{e.error&&(e=e.error);let a="ERROR "+e.code+(e.detailedMessage?": "+e.detailedMessage:"");e.displayMessage&&(a=e.displayMessage+(e.detailedMessage?": "+e.detailedMessage:"")),d(a,[]),e.detailedMessage&&e.detailedMessage.includes("User aborted payment")?s(e.detailedMessage):R?(R=!1,s(a)):s((0,t.__)("Error! Unable to set up Express Checkout at this moment. Please, try again later.","paysafe-checkout")+(e.code?" ("+e.code+")":""))}))},R=a=>{const{eventRegistration:n,emitResponse:c}=a,{onCheckoutSuccess:i}=n;(0,o.useEffect)((()=>{const e=i((e=>{const a=e.orderId,s=e&&e.processingResponse&&e.processingResponse.paymentDetails&&e.processingResponse.paymentDetails.single_use_token?e.processingResponse.paymentDetails.single_use_token:"",n=e&&e.processingResponse&&e.processingResponse.paymentDetails&&e.processingResponse.paymentDetails.merch_ref_num?e.processingResponse.paymentDetails.merch_ref_num:"";let o=null;if(y=parseInt(h.cartTotals.total_price),!a||!y)return d((0,t.__)("The payment process failed. Please close this popup and try again","paysafe-checkout"),[]),{type:c.responseTypes.ERROR,message:(0,t.__)("The payment process failed. Please close this popup and try again","paysafe-checkout")};{let e=h.cartTotals.currency_code,c=h.billingAddress.first_name,i=h.billingAddress.last_name,l=h.billingAddress.email,p=h.billingAddress.address_1,u=h.billingAddress.address_2,m=h.billingAddress.city,_=h.billingAddress.postcode,f=h.billingAddress.state,E=h.billingAddress.country;h.billingAddress.phone;const R={transactionSource:"WooCommerceCheckout",amount:y,transactionType:"PAYMENT",currency:e,merchantRefNum:n,environment:r.test_mode?"TEST":"LIVE",displayPaymentMethods:["applePay"],paymentMethodDetails:{applePay:{accountId:r.account_id,label:"apple_pay"}},threeDs:{merchantUrl:r.checkout_url,deviceChannel:"BROWSER",messageCategory:"PAYMENT",authenticationPurpose:"PAYMENT_TRANSACTION",transactionIntent:"GOODS_OR_SERVICE_PURCHASE"},locale:r.locale};r.merchant_descriptor&&r.merchant_phone&&(R.merchantDescriptor={dynamicDescriptor:r.merchant_descriptor,phone:r.merchant_phone}),R.singleUseCustomerToken=s,R.customer={firstName:c,lastName:i,email:l},R.billingAddress={nickName:"Home",zip:_,country:E},p&&(R.billingAddress.street=p),u&&(R.billingAddress.street2=u),m&&(R.billingAddress.city=m),f&&(R.billingAddress.state=f),paysafe.checkout.setup(r.authorization,R,(function(e,s,n){if(n&&n.paymentHandleToken){const o={orderId:a,paymentMethod:n.paymentMethod,transactionType:n.transactionType,paymentHandleToken:n.paymentHandleToken,amount:n.amount,customerOperation:n.customerOperation,merchantRefNum:R.merchantRefNum,nonce:r.nonce};fetch(r.register_url,{method:"POST",credentials:"same-origin",headers:new Headers({"Content-Type":"application/json"}),body:JSON.stringify(o)}).then((e=>e.json())).then((a=>{"success"===a.status?e.showSuccessScreen((0,t.__)("Your goods are now purchased. Expect them to be delivered in next 5 business days.","paysafe-checkout")):(d("Payment failed. Popup was closed without a correct end message!",s),e.showFailureScreen((0,t.__)("The payment process failed. Please close this popup and try again","paysafe-checkout"))),g=a.redirect_url})).catch((a=>{d((0,t.__)("The payment process failed. Please close this popup and try again","paysafe-checkout"),a),e.showFailureScreen((0,t.__)("The payment process failed. Please close this popup and try again","paysafe-checkout"))}))}else{let a="";s&&(s.code&&(a+=s.code+" "),s.message&&(a+=s.message+" "),s.detailedMessage&&(a+=s.detailedMessage)),e?(d((0,t.__)("Payment failed. Popup was closed without a correct end message!","paysafe-checkout")+" "+a,{pace:3}),e.showFailureScreen((0,t.__)("The payment was declined. Please, try again with the same or another payment method. "+a,"paysafe-checkout"))):(o=(0,t.__)("The payment was declined. Please, try again with the same or another payment method.","paysafe-checkout"),s&&s.code&&s.detailedMessage&&(o+="<br /> "+s.code+" "+s.detailedMessage),d(o,[]),function(e){let t=document.getElementsByClassName("woocommerce-error");if(t=t.length>0?t[0]:null,!t){let e=document.getElementsByClassName("woocommerce-notices-wrapper"),a=e.length>0?e[0]:null;a&&(t=document.createElement("ul"),t.className="woocommerce-error",a.appendChild(t))}if(t){let a=document.getElementById("paysafe-fatal-error-message");a?a.innerHTML=e:(a=document.createElement("li"),a.setAttribute("id","paysafe-fatal-error-message"),a.innerHTML=e,t.appendChild(a),window.scrollTo({top:0,left:0,behavior:"smooth"}))}}(o))}}),(function(e,t){if(e)switch(e){case"PAYMENT_HANDLE_NOT_CREATED":window.location.reload();break;case"PAYMENT_HANDLE_CREATED":case"PAYMENT_HANDLE_REDIRECT":case"PAYMENT_HANDLE_PAYABLE":if(null!==g)return void(window.location=g);window.location.reload()}else window.location.reload()}),(function(e,a,s){a===y?e.accept():(d((0,t.__)("Amount is not the value expected","paysafe-checkout"),[]),e.decline((0,t.__)("Amount is not the value expected","paysafe-checkout")))}))}return e}));return()=>{e()}}),[c.responseTypes.ERROR,c.responseTypes.SUCCESS,"",[],i]);let l=[(0,e.createElement)("div",null,(0,s.decodeEntities)(r.description||""))];return r.test_mode&&(l.push((0,e.createElement)("hr",null)),l.push((0,e.createElement)("div",{style:{textAlign:"justify",marginTop:"10px"}},(0,e.createElement)("span",null,(0,t.__)("Paysafe Checkout is in TEST mode. Use the built-in simulator to test payments.","paysafe-checkout"))))),l},T=()=>{let a=(0,e.createElement)("div",{className:"paysafe-gateway-title"},(0,e.createElement)("span",null,u),(0,e.createElement)("img",{className:"paysafe-gateway-image",src:r.icon,alt:u}));if(l){let a=(0,t.__)("Paysafe Express Payment","paysafe-checkout");return(0,e.createElement)("div",{className:"paysafe-gateway-title"},(0,e.createElement)("span",null,a))}return a},k=a=>{const{eventRegistration:n,onClick:c,onClose:i,onError:d}=a,{onCheckoutSuccess:p}=n;(0,o.useEffect)((()=>{E(c,i,d);const e=p((e=>e));return()=>{e()}}),[[],{},p]);let u=[(0,e.createElement)("div",null,(0,s.decodeEntities)(r.description||""))];return l&&(u=[(0,e.createElement)("div",null,(0,s.decodeEntities)((0,t.__)("Easy and secure payments with Paysafe","paysafe-checkout")))]),r.test_mode&&(u.push((0,e.createElement)("hr",null)),u.push((0,e.createElement)("div",{style:{textAlign:"justify",marginTop:"10px"}},(0,e.createElement)("span",null,(0,t.__)("Paysafe Checkout is in TEST mode. Use the built-in simulator to test payments.","paysafe-checkout")))),u.push((0,e.createElement)("p",null))),u.push(wp.element.RawHTML({children:r.integration_hosted_form})),u};if(p){const t={name:c,title:"Apple Pay Express Checkout",description:r.description,gatewayId:"paysafe",label:(0,e.createElement)(T,null),content:(0,e.createElement)(k,null),edit:(0,e.createElement)(k,null),canMakePayment:e=>(h=e,!(!e.billingAddress||""===e.billingAddress.email||""===e.billingAddress.first_name||""===e.billingAddress.last_name||""===e.billingAddress.address_1||""===e.billingAddress.city||""===e.billingAddress.postcode)||(f=!1,!1)),paymentMethodId:c,supports:{features:r.supports}};(0,a.registerExpressPaymentMethod)(t)}else{const t={name:c,paymentMethodId:c,label:(0,e.createElement)(m,null),content:(0,e.createElement)(R,null),edit:(0,e.createElement)(R,null),canMakePayment:e=>(h=e,!0),ariaLabel:u,supports:{features:r.supports}};(0,a.registerPaymentMethod)(t)}})();